<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BR Citizen Labs — Ecosystem</title>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/venn.js@0.2.20/venn.js"></script>

<link rel="stylesheet" href="header.css">
<script src="header.js" defer></script>

<style>

body {
    margin: 0;
    padding: 0;
    font-family: 'Courier New', 'Lucida Console', Monaco, monospace;
    background-color: #808000;
}

#main-content {
    margin: 0 20px 30px 20px;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: center;
}

#filter-menu, #venn-section {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
}

#filter-menu {
    background-color: rgba(0,0,0,0.4);
    color: white;
    padding: 15px;
    border-radius: 15px;
    font-size: 0.9rem;
    width: 100%;
    box-sizing: border-box;
    flex: 0 0 280px;
}

#filter-menu h4 {
    margin-top: 0;
}

.filter-instruction {
    font-size: 0.8rem;
    color: grey;
    margin: 4px 0;
}

#lab-list { 
    max-height: 150px; 
    overflow-y: auto; 
    padding-left: 0; 
    list-style: none; 
    font-size: 0.85rem; 
}

#color-key-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: left;
    gap: 6px;
    margin-top: 6px;
}

#color-key-wrapper strong {
    color: white;
    font-size: 1rem;       
}

#color-key-container span {
    padding: 2px 6px;
    border-radius: 3px;
    color: #fff;
    font-size: 0.85rem; 
}

#tags-container {
    display: flex;
    flex-direction: column;
    gap: 5px;
    font-size: 0.85rem; 
}

#venn-section {
    background-color: rgba(0,0,0,0.4);
    border-radius: 15px;
    padding: 10px;
    width: 100%;
    flex: 1;
    align-items: center;
}

#venn-section h3 { 
    text-align: center; 
    color: white; 
}

#venn-diagram-svg-wrapper {
    display: flex;
    justify-content: center; 
    align-items: center;   
    flex: 1;
    min-height: 500px;
}

#venn-diagram-svg-wrapper svg { 
    width: 100%; 
    max-width: 500px; 
    height: auto; 
}

.venn-area path {
    cursor: pointer;
    fill-opacity: 0.5;
    stroke: white;
    stroke-width: 2px;
}

.venn-area path:hover { fill-opacity: 1 !important; }

.venn-area text {
    font-family: Verdana, sans-serif;
    font-size: 14px;
    font-weight: 600;
    fill: white !important;
    text-anchor: middle;
    dominant-baseline: middle;
    pointer-events: none;
    paint-order: stroke;
    stroke: rgba(0,0,0,0.8);
    stroke-width: 3px;
}

@media(min-width: 768px){
    #main-content { 
        flex-direction: row; 
        align-items: stretch; 
        gap: 20px; 
    }
    #venn-section { 
        width: 100%; 
        align-items: center; 
    }
    #lab-list { max-height: 500px; }
}

@media(max-width: 767px){
    #venn-diagram-svg-wrapper { min-height: 250px; }
    #venn-section { padding: 10px; }
}
</style>
</head>

<body data-page="ecosystem">

<div id="main-content">

   <div id="filter-menu">
      <h4>Labs by Tag</h4>
      <p class="filter-instruction">Click on the diagram to filter labs by tag.</p>
      <button id="clear-filters">Clear all filters</button>
      <div id="lab-count" style="margin:10px 0;font-weight:bold;">0 labs found</div>
      <div id="tags-container">
          <ul id="lab-list"></ul>
      </div>
   </div>

   <div id="venn-section">
      <h3>Labs by Category</h3>
      <div id="venn-diagram-svg-wrapper"></div>
      <div id="color-key-wrapper">
          <strong>Tags:</strong>
          <div id="color-key-container"></div>
      </div>
   </div>

</div>

<script>
let activeVennFilters = new Set();
let allLabData = [];

fetch('labsData.json')
    .then(r => r.json())
    .then(d => { allLabData = d; filterAndDisplayLabs(); });

const ecosystemData = [
    {sets:['Civiles'], size:108, label:'Civil Society 63', color:'#7570b3'},
    {sets:['Educacionales'], size:87, label:'Educational 26', color:'#1b9e77'},
    {sets:['Gubernamentales'], size:52, label:'Governmental 9', color:'#d95f02'},
    {sets:['Civiles','Educacionales'], size:31, label:'31'},
    {sets:['Civiles','Gubernamentales'], size:13, label:'13'},
    {sets:['Educacionales','Gubernamentales'], size:28, label:'28'},
    {sets:['Civiles','Educacionales','Gubernamentales'], size:2, label:'2'}
];

const categoryColors = {
  "Asociación civil u ONG": "#1f77b4",
  "Asociación civil u ONG/Educación básica": "#4d0773",
  "Asociación civil u ONG/Gobierno local": "#0ec991",
  "Ecosistema empresarial": "#032863",
  "Ecosistema empresarial/Educación básica": "#9467bd",
  "Ecosistema empresarial/Educación superior/Gobierno estatal": "#8c564b",
  "Ecosistema empresarial/Educación superior/Gobierno federal": "#e377c2",
  "Educación básica": "#ff7105",
  "Educación básica/Gobierno local": "#4a4a0f",
  "Educación superior": "#a64902",
  "Educación superior/Gobierno estatal": "#332605",  
  "Educación superior/Gobierno federal": "#f2d33c",  
  "Educación superior/Gobierno local": "#a07711",   
  "Escuela de inglés": "#f5a96e",
  "Gobierno federal": "#006400",
  "Gobierno local": "#13bd13",
  "Independiente": "#7898cf"
};

const categoryLabelsEN = {
  "Asociación civil u ONG": "Civil Association or NGO",
  "Asociación civil u ONG/Educación básica": "Civil Association / Primary Education",
  "Asociación civil u ONG/Gobierno local": "Civil Association / Local Government",
  "Ecosistema empresarial": "Business Ecosystem",
  "Ecosistema empresarial/Educación básica": "Business / Primary Education",
  "Ecosistema empresarial/Educación superior/Gobierno estatal": "Business / Higher Education / State Government",
  "Ecosistema empresarial/Educación superior/Gobierno federal": "Business / Higher Education / Federal Government",
  "Educación básica": "Primary Education",
  "Educación básica/Gobierno local": "Primary Education / Local Government",
  "Educación superior": "Higher Education",
  "Educación superior/Gobierno estatal": "Higher Education / State Government",
  "Educación superior/Gobierno federal": "Higher Education / Federal Government",
  "Educación superior/Gobierno local": "Higher Education / Local Government",
  "Escuela de inglés": "English Language School",
  "Gobierno federal": "Federal Government",
  "Gobierno local": "Local Government",
  "Independiente": "Independent"
};

const chart = venn.VennDiagram().width(500).height(500);
d3.select("#venn-diagram-svg-wrapper").datum(ecosystemData).call(chart);

const svg = d3.select("#venn-diagram-svg-wrapper svg");
svg
    .attr("viewBox", "0 0 500 500")
    .attr("preserveAspectRatio", "xMidYMid meet")
    .style("width", "100%")
    .style("height", "auto");

function canonicalKey(arr){ return arr.slice().sort().join('/'); }

function highlight(selectedRegions){
    d3.selectAll('.venn-area path')
      .style('opacity', d => selectedRegions.size === 0 || selectedRegions.has(canonicalKey(d.sets)) ? 1 : 0.2);
}

function filterAndDisplayLabs(){
    if(!allLabData) return;

    const filteredLabs = allLabData.filter(d => {
        const key = d.region ? d.region.split('/').sort().join('/') : '';
        return activeVennFilters.size === 0 || activeVennFilters.has(key);
    });

    const visibleTags = new Set();
    filteredLabs.forEach(lab => lab.categories.forEach(cat => visibleTags.add(cat)));

    const keyDiv = d3.select("#color-key-container").html("");

    Array.from(visibleTags)
      .sort((a, b) => (categoryLabelsEN[a] || a).localeCompare(categoryLabelsEN[b] || b))
      .forEach(tag => {
          keyDiv.append('span')
                .text(categoryLabelsEN[tag] || tag)
                .style('background-color', categoryColors[tag] || '#000');
      });

    const list = d3.select("#lab-list").html('');
    filteredLabs.forEach(lab => {
        const li = list.append('li').style('display','flex').style('align-items','center').style('gap','6px');
        lab.categories.forEach(c => li.append('span')
            .style('width','12px')
            .style('height','12px')
            .style('background',categoryColors[c]||'#000')
            .style('border','1px solid #333')
            .style('border-radius','3px'));
        li.append('span').text(lab.lab_name);
    });

    d3.select("#lab-count").text(`${filteredLabs.length} labs found`);
}

d3.selectAll('.venn-area').on('click',(e,d)=>{
    const k = canonicalKey(d.sets);
    activeVennFilters.has(k) ? activeVennFilters.delete(k) : activeVennFilters.add(k);
    highlight(activeVennFilters);
    filterAndDisplayLabs();
});

document.getElementById("clear-filters").onclick = ()=>{
    activeVennFilters.clear();
    highlight(activeVennFilters);
    filterAndDisplayLabs();
};

highlight(activeVennFilters);
filterAndDisplayLabs();
</script>

</body>
</html>
